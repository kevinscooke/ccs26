generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model City {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  region    String?
  heroCopy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  events    Event[]
  series    Series[]
}

model Organizer {
  id        String        @id @default(cuid())
  name      String
  email     String        @unique
  phone     String?
  verified  Boolean       @default(false)
  plan      OrganizerPlan @default(FREE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  events    Event[]
  invoices  Invoice[]
}

enum OrganizerPlan {
  FREE
  PLUS
  PRO
}

model Venue {
  id        String   @id @default(cuid())
  name      String
  address1  String
  address2  String?
  city      String
  state     String
  postal    String
  lat       Decimal? @db.Decimal(9, 6)
  lng       Decimal? @db.Decimal(9, 6)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  events    Event[]
  series    Series[]

  @@unique([name, address1, city, state, postal])
}

model Series {
  id          String  @id @default(cuid())
  title       String
  slugBase    String  @unique
  description String? // ⬅️ optional description

  cityId  String
  city    City    @relation(fields: [cityId], references: [id])
  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id])

  timeZone              String    @default("America/New_York")
  startHour             Int       @default(8)
  startMinute           Int       @default(0)
  durationMin           Int       @default(240)
  rrule                 String
  generateHorizonMonths Int       @default(6)
  lastGeneratedThrough  DateTime?

  exceptions SeriesException[]
  events     Event[]
}

model SeriesException {
  id       String @id @default(cuid())
  seriesId String
  series   Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  /// Local exception date (store at ET midnight or a canonical UTC midnight)
  date DateTime

  /// Behavior for this date (example fields; keep what you need)
  // skip       Boolean  @default(true)
  // newTitle   String?
  // newHour    Int?
  // newMinute  Int?
  // newDurationMin Int?
  // notes      String?

  createdAt DateTime @default(now())

  // ensure only one exception per series per date
  @@unique([seriesId, date])
  @@index([seriesId])
}

model Event {
  id          String     @id @default(cuid())
  cityId      String
  city        City       @relation(fields: [cityId], references: [id])
  organizerId String?
  organizer   Organizer? @relation(fields: [organizerId], references: [id])
  venueId     String?
  venue       Venue?     @relation(fields: [venueId], references: [id])

  seriesId String?
  series   Series? @relation(fields: [seriesId], references: [id])

  title       String
  slug        String      @unique
  description String?
  startAt     DateTime
  endAt       DateTime?
  type        EventType   @default(MEET)
  status      EventStatus @default(PENDING)
  isFeatured  Boolean     @default(false)
  price       Int?
  source      String?
  url         String?
  images      Image[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  publishedAt DateTime?
  flagged     Boolean     @default(false)

  @@index([status, startAt]) // keeps chronological queries fast
}

enum EventType {
  CARS_AND_COFFEE
  SHOW
  MEET
  TRACK
  OTHER
}

enum EventStatus {
  PENDING
  APPROVED
  PUBLISHED
  REJECTED
}

model Image {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  url       String
  width     Int?
  height    Int?
  alt       String?
  createdAt DateTime @default(now())
}

model Invoice {
  id          String        @id @default(cuid())
  organizerId String
  organizer   Organizer     @relation(fields: [organizerId], references: [id])
  stripeId    String        @unique
  amount      Int
  status      InvoiceStatus @default(PAID)
  lineItem    String
  eventId     String?
  createdAt   DateTime      @default(now())
}

enum InvoiceStatus {
  PAID
  REFUNDED
  FAILED
}
